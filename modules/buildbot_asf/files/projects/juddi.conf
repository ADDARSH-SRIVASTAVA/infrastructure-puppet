# This is the config file for the juddi project.
# Also contains config for the 'scout' sub-project.
from buildbot.changes.filter import ChangeFilter
from buildbot.schedulers import timed

# schedulers
main=SingleBranchScheduler(name="on-juddi-hibernate-commit",
                        change_filter=filter.ChangeFilter(branch='master' , project='juddi'),
                        treeStableTimer=60,
                        builderNames=["juddi-trunk-hibernate" , "juddi-trunk-win7-hibernate","juddi-trunk-hibernate-openjdk",
					"juddi-trunk-openjpa","juddi-trunk-win7-openjpa", "juddi-trunk-openjpa-openjdk"])
c['schedulers'].append(main)

c['schedulers'].append(SingleBranchScheduler(name="on-juddi-trunk-dotnet-commit",
                        change_filter=filter.ChangeFilter(branch='master' , project='juddi'),
                        treeStableTimer=60,
                        builderNames=["juddi-trunk-dotnet"]))

#,"juddi-trunk-dotnet-mono"


c['schedulers'].append(SingleBranchScheduler(name="on-scout-commit",
                        change_filter=filter.ChangeFilter(branch='master' , project='juddi-scout'),
                        treeStableTimer=60,
                        builderNames=["scout-trunk"]))

# locks

juddilock_1 = locks.SlaveLock("juddiwin_builds")
juddilock_2 = locks.SlaveLock("juddiubt_builds")

#builders

#hibernate

f_jud_24 = factory.BuildFactory()
f_jud_24.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi.git"))
f_jud_24.addStep(Compile(command=["mvn", "clean" , "install" , "-Phibernate"],
            env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
				locks=[juddilock_2.access("exclusive")]
))
f_jud_24.addStep(Compile(command=["mvn", "clean" , "install" , "-Pdist"],
            env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
				locks=[juddilock_2.access("exclusive")]
))

b_jud_24 = {'name': "juddi-trunk-hibernate",
      'slavename': "orcus_ubuntu",
      'builddir': "juddi-trunk-hibernate",
      'factory': f_jud_24,
      'category': "juddi-trunk-hibernate",
      'env': {'M2_HOME': '/home/buildslave1/slave1/tools/maven/latest3/',
              'M2': '/home/buildslave1/slave1/tools/maven/latest3/bin',
              'JAVA_HOME': '/usr/lib/jvm/java-7-openjdk-amd64',
              'PATH': '/home/buildslave1/slave1/tools/maven/latest3/bin:/usr/lib/jvm/java-7-openjdk-amd64/bin:/usr/share:/usr/local/bin:/usr/bin:/bin'},
      }

c['builders'].append(b_jud_24)

f_jud_26 = factory.BuildFactory()
f_jud_26.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi.git"))
f_jud_26.addStep(Compile(command=["mvn", "clean" , "install" , "-Phibernate"],
            env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
				locks=[juddilock_2.access("exclusive")]
))
f_jud_26.addStep(Compile(command=["mvn", "clean" , "install" , "-Pdist"],
            env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
				locks=[juddilock_2.access("exclusive")]
))

b_jud_26 = {'name': "juddi-trunk-hibernate-openjdk",
      'slavename': "orcus_ubuntu",
      'builddir': "juddi-trunk-hibernate-openjdk",
      'factory': f_jud_24,
      'category': "juddi-trunk-hibernate-openjdk",
      'env': {'M2_HOME': '/home/buildslave1/slave1/tools/maven/latest3/',
              'M2': '/home/buildslave1/slave1/tools/maven/latest3/bin',
	      'JAVA_HOME': '/usr/lib/jvm/java-7-openjdk-amd64',
              'PATH': '/home/buildslave1/slave1/tools/maven/latest3/bin:/usr/lib/jvm/java-7-openjdk-amd64/bin:/usr/share:/usr/local/bin:/usr/bin:/bin'},
      }

c['builders'].append(b_jud_26)



#openjpa

f_jud_25 = factory.BuildFactory()
f_jud_25.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi.git"))
f_jud_25.addStep(Compile(command=["mvn", "clean" ,"install", "-Popenjpa"],
                   env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
						locks=[juddilock_2.access("exclusive")]
))
f_jud_25.addStep(Compile(command=["mvn", "clean" ,"install", "-Pdist"],
                   env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
						locks=[juddilock_2.access("exclusive")]
))

b_jud_25 = {'name': "juddi-trunk-openjpa",
      'slavename': "orcus_ubuntu",
      'builddir': "juddi-trunk-openjpa",
      'factory': f_jud_25,
      'category': "juddi-trunk-openjpa",
      'env': {'M2_HOME': '/home/buildslave1/slave1/tools/maven/latest3/',
              'M2': '/home/buildslave1/slave1/tools/maven/latest3/bin',
              'JAVA_HOME': '/usr/lib/jvm/java-7-openjdk-amd64',
              'PATH': '/home/buildslave1/slave1/tools/maven/latest3/bin:/usr/lib/jvm/java-7-openjdk-amd64/bin:/usr/share:/usr/local/bin:/usr/bin:/bin'},
      }

c['builders'].append(b_jud_25)



f_jud_27 = factory.BuildFactory()
f_jud_27.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi.git"))
f_jud_27.addStep(Compile(command=["mvn", "clean" ,"install", "-Popenjpa"],
                   env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
						locks=[juddilock_2.access("exclusive")]
))
f_jud_27.addStep(Compile(command=["mvn", "clean" ,"install", "-Pdist"],
                   env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
						locks=[juddilock_2.access("exclusive")]
))

b_jud_27 = {'name': "juddi-trunk-openjpa-openjdk",
      'slavename': "orcus_ubuntu",
      'builddir': "juddi-trunk-openjpa-openjdk",
      'factory': f_jud_27,
      'category': "juddi-trunk-openjpa-openjdk",
      'env': {'M2_HOME': '/home/buildslave1/slave1/tools/maven/latest3/',
              'M2': '/home/buildslave1/slave1/tools/maven/latest3/bin',
              'JAVA_HOME': '/usr/lib/jvm/java-7-openjdk-amd64',
              'PATH': '/home/buildslave1/slave1/tools/maven/latest3/bin:/usr/lib/jvm/java-7-openjdk-amd64/bin:/usr/share:/usr/local/bin:/usr/bin:/bin'},
      }

c['builders'].append(b_jud_27)

f_jud_4 = factory.BuildFactory()
f_jud_4.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi.git"))
f_jud_4.addStep(Compile(command=["mvn", "clean" , "install" , "-Phibernate"],
                   env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
                        locks=[juddilock_1.access("exclusive")]
))

b_jud_4 = {'name': "juddi-trunk-win7-hibernate",
      'slavename': "bb-win7",
      'builddir': "juddi-trunk-win7-hibernate",
      'factory': f_jud_4,
      'category': "juddi-trunk-win7-hibernate",
      'env': {'M2_HOME': 'E:\\maven\\apache-maven-3.1.0',
              'MAVEN_HOME': 'E:\\maven\\apache-maven-3.1.0',
              'M2': 'E:\\maven\\apache-maven-3.1.0\\bin',
              'PATH': 'E:\\maven\\apache-maven-3.1.0\\bin;${PATH}'},
      }

c['builders'].append(b_jud_4)

f_jud_5 = factory.BuildFactory()
f_jud_5.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi.git"))
f_jud_5.addStep(Compile(command=["mvn", "clean" ,"install", "-Popenjpa"],
                   env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
                        locks=[juddilock_1.access("exclusive")]
))
f_jud_5.addStep(Compile(command=["mvn", "clean" ,"install", "-Pdist"],
                   env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
                        locks=[juddilock_1.access("exclusive")]
))

b_jud_5 = {'name': "juddi-trunk-win7-openjpa",
      'slavename': "bb-win7",
      'builddir': "juddi-trunk-win7-openjpa",
      'factory': f_jud_5,
      'category': "juddi-trunk-win7-openjpa",
      'env': {'M2_HOME': 'E:\\maven\\apache-maven-3.1.0',
              'MAVEN_HOME': 'E:\\maven\\apache-maven-3.1.0',
              'M2': 'E:\\maven\\apache-maven-3.1.0\\bin',
              'PATH': 'E:\\maven\\apache-maven-3.1.0\\bin;${PATH}'},
      }

c['builders'].append(b_jud_5)

#juddi-trunk-dotnet

f_jud_6 = factory.BuildFactory()
f_jud_6.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi.git"))

#build the java bits
f_jud_6.addStep(Compile(command=["mvn" ,"install", "-DskipTests=true"],
                   env={'MAVEN_OPTS': '-Xmx768m -XX:MaxPermSize=512m'},
                        locks=[juddilock_1.access("exclusive")]
))
#build .net bits
f_jud_6.addStep(Compile(command=["%WINDIR%\\Microsoft.NET\\Framework\\v3.5\\msbuild.exe @juddi-client.net\\clean.txt"]))
f_jud_6.addStep(Compile(command=["%WINDIR%\\Microsoft.NET\\Framework\\v3.5\\msbuild.exe @juddi-client.net\\input.txt"]))
#this run basic integration tests
f_jud_6.addStep(Compile(command=["juddi-client.net\\bb-win7.bat"]))
#this will start up tomcat and run some live tests
# commented out because tomcat wasn't starting/stopping correctly in this environment
#f_jud_6.addStep(Compile(command=["juddi-client.net\\integrationTests.bat"],locks=[juddilock_1.access("exclusive")]))
b_jud_6 = {'name': "juddi-trunk-dotnet",
      'slavename': "bb-win7",
      'builddir': "juddi-trunk-dotnet",
      'factory': f_jud_6,
      'category': "juddi-trunk-dotnet",
	  'env': {'M2_HOME': 'E:\\maven\\apache-maven-3.1.0',
              'MAVEN_HOME': 'E:\\maven\\apache-maven-3.1.0',
              'M2': 'E:\\maven\\apache-maven-3.1.0\\bin',
			  'NUNIT_HOME': 'C:\\Program Files\\NUnit 2.6.2',
              'PATH': 'E:\\maven\\apache-maven-3.1.0\\bin;${PATH}'}
      }
      
c['builders'].append(b_jud_6)

#build the .net parts using mono and test using unit

#f_jud_71 = factory.BuildFactory()
#f_jud_71.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi.git"))
#f_jud_71.addStep(Compile(command=["xbuild", "juddi-client.net/juddi-client.net-mono.sln","/target:clean"]))
#f_jud_71.addStep(Compile(command=["xbuild", "juddi-client.net/juddi-client.net-mono.sln"]))
#f_jud_71.addStep(Compile(command=["mono", "/home/buildslave1/tools/nunit/latest/bin/nunit-console.exe", "./juddi-client.net/juddi-client.net.test/bin/Debug/juddi-client.net.test.dll"]))

#b_jud_71 = {'name': "juddi-trunk-dotnet-mono",
#      'slavename': "orcus_ubuntu",
#      'builddir': "juddi-trunk-dotnet-mono",
#      'factory': f_jud_71, 
#      'category': "juddi-trunk-dotnet-mono",
#      'env': {'MAVEN_HOME': 'E:\\maven\\apache-maven-3.1.0',
#              'M2': 'E:\\maven\\apache-maven-3.1.0\\bin',
#              'PATH': 'E:\\maven\\apache-maven-3.1.0\\bin;${PATH}'},
#      }
#
#c['builders'].append(b_jud_71)

#scout
f_sco_1 = factory.BuildFactory()
f_sco_1.addStep(Git(repourl="https://git-wip-us.apache.org/repos/asf/juddi-scout.git", mode="full"))
f_sco_1.addStep(Compile(command=["mvn", "clean", "package"]))

b_sco_1 = {'name': "scout-trunk",
      'slavename': "orcus_ubuntu",
      'builddir': "scout-trunk",
      'factory': f_sco_1,
      'category': "scout-trunk",
      'env': {'M2_HOME': '/home/buildslave1/slave1/tools/maven/latest3/',
              'M2': '/home/buildslave1/slave1/tools/maven/latest3/bin',
              'JAVA_HOME': '/usr/lib/jvm/java-7-openjdk-amd64',
              'PATH': '/home/buildslave1/slave1/tools/maven/latest3/bin:/usr/lib/jvm/java-7-openjdk-amd64/bin:/usr/share:/usr/local/bin:/usr/bin:/bin'},
      }

c['builders'].append(b_sco_1)

#mail status

c['status'].append(mail.MailNotifier(fromaddr="buildbot@apache.org",
                                     extraRecipients=["dev@juddi.apache.org"],
                                     sendToInterestedUsers=False,
                                     mode="change",
                                     categories=["juddi-trunk-hibernate" , "juddi-trunk-openjpa" , "scout-trunk" ,
                                        "juddi-trunk-win7-hibernate", "juddi-trunk-win7-openjpa" , "juddi-trunk-dotnet",
					        ]))
										
#"juddi-trunk-dotnet-mono",

c['status'].append(words.IRC(host="irc.freenode.net", nick="juddi-bot",
                              allowForce=True,
                              channels=["#juddi"],
			      notify_events={
				'started': 1,
				'finished': 1,
				'successToFailure': 1,
				'failureToSuccess': 1,
				},
                              categories=["juddi-trunk-hibernate" , "juddi-trunk-openjpa" , "juddi-trunk-hibernate-openjdk" , "juddi-trunk-openjpa-openjdk" , 
				          "scout-trunk" , "juddi-trunk-win7-hibernate" , "juddi-trunk-win7-openjpa", "juddi-trunk-dotnet"
                                         ]))
#"juddi-trunk-dotnet-mono",
