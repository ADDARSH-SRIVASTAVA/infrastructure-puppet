# -*- python -*-
from buildbot.changes.filter import ChangeFilter

def cms_staging_build(project=None, buildtype='perl', commitlist=None, branch=None, timeout=3600):

    if project is None:
        raise ValueError("project must be explicitly set!")
    if commitlist is None:
        commitlist = 'commits@' + project + '.apache.org'
    if branch is None:
        branch = project.replace("-", "/") + '/site' # project=tlp-subproject: eg maven-doxia
    branch_re = '(?:incubator/)?%s' % branch
    del branch

    pss          = project + '-site-staging'
    source_base  = "/home/cmsslave/slave15/%s/build/trunk" % pss
    target_base  = "/usr/local/websites/%s/trunk"          % project
    build_bindir = "/usr/local/cms/build"

    f = factory.BuildFactory()
    if buildtype == "perl":
        f.addStep(Compile(command=["perl", build_bindir + "/build_svn.pl",
                                   "--source-base=" + source_base,
                                   "--target-base=" + target_base],
                          timeout=timeout))
    else:
        f.addStep(Compile(command=["perl", build_bindir + "/build_external.pl",
                                   "--type=" + buildtype,
                                   "--source-base=" + source_base,
                                   "--target-base=" + target_base],
                          timeout=timeout))
    f.addStep(ShellCommand(command=["svn", "ci", "--username=buildbot", target_base,
                                    "-m", "Staging update by buildbot for " + project],
                           timeout=timeout))
    b = {
        'name'     : pss,
        'slavename': "bb-cms-slave",
        'builddir' : pss,
        'factory'  : f,
        'category' : pss,
        }

    c['schedulers'].append(AnyBranchScheduler(name="on-" + project + "-site-commit",
                                              change_filter=ChangeFilter(branch_re=branch_re),
                                              treeStableTimer=2,
                                              builderNames=[pss]))
    c['builders'].append(b)
    c['status'].append(mail.MailNotifier(fromaddr="buildbot@apache.org",
                                         extraRecipients=[commitlist],
                                         sendToInterestedUsers=False,
                                         mode="change",
                                         categories=[pss]))

# the list

cms_staging_build(project="river")
cms_staging_build(project='stanbol')
cms_staging_build(project="community", commitlist="dev@community.apache.org", branch='comdev/site')
cms_staging_build(project='zookeeper', commitlist='dev@zookeeper.apache.org')
cms_staging_build(project='opennlp')
cms_staging_build(project='aries')
cms_staging_build(project='jena')
cms_staging_build(project='esme')
cms_staging_build(project='celix', commitlist='dev@celix.apache.org')
cms_staging_build(project='lucene.net', commitlist='dev@lucenenet.apache.org')
cms_staging_build(project='chemistry')
cms_staging_build(project='wave', commitlist='wave-commits@incubator.apache.org')
cms_staging_build(project='sling')
cms_staging_build(project='rave')
cms_staging_build(project='airavata')
cms_staging_build(project='accumulo')
cms_staging_build(project='labs', branch='labs/cms')
cms_staging_build(project='flex')
cms_staging_build(project='devicemap')
cms_staging_build(project='ace')
cms_staging_build(project='events', commitlist='concom@apache.org', branch='concom/site')
cms_staging_build(project='incubator', commitlist='cvs@incubator.apache.org', buildtype='shell', branch='incubator/public')
cms_staging_build(project='maven', buildtype='maven')
cms_staging_build(project='maven-doxia', buildtype='maven', commitlist='commits@maven.apache.org')
cms_staging_build(project='bval', branch='bval/cms-site')
cms_staging_build(project='xmlgraphics')
cms_staging_build(project='sqoop', buildtype='maven')
cms_staging_build(project='mrunit')
cms_staging_build(project='james', buildtype='maven', commitlist='site-dev@james.apache.org', branch='james/site-cms')
cms_staging_build(project='directory')
cms_staging_build(project='jspwiki')
cms_staging_build(project='logging', branch='logging/site/cms')
cms_staging_build(project='cloudstack', commitlist='dev@cloudstack.apache.org')
cms_staging_build(project='deltaspike', commitlist='dev@deltaspike.apache.org')
cms_staging_build(project='sis')
cms_staging_build(project='shindig', commitlist='dev@shindig.apache.org', branch='shindig/site/trunk/cms')
cms_staging_build(project='ctakes', commitlist='dev@ctakes.apache.org')
cms_staging_build(project='vcl')
cms_staging_build(project='flume', buildtype='maven')
cms_staging_build(project='blur', commitlist='blur-commits@incubator.apache.org')
cms_staging_build(project='crunch')
cms_staging_build(project='db', commitlist='general@db.apache.org', branch='db/site-cms')
cms_staging_build(project='drill', commitlist='dev@drill.apache.org')
cms_staging_build(project='oozie', buildtype='maven')
cms_staging_build(project='mina')
cms_staging_build(project='bigtop', buildtype='maven')
cms_staging_build(project='isis')
cms_staging_build(project='ode')
cms_staging_build(project='openjpa')
cms_staging_build(project='streams', commitlist='dev@streams.incubator.apache.org')
cms_staging_build(project='myfaces', branch='myfaces/site/cms-site')
cms_staging_build(project='commons', buildtype='maven', commitlist='notifications@commons.apache.org', branch='commons/cms-site')
cms_staging_build(project='felix')
cms_staging_build(project='shiro', branch='shiro/cms')
cms_staging_build(project='roller', commitlist='dev@roller.apache.org', branch='roller/cmssite')
cms_staging_build(project='struts', buildtype='shell')
cms_staging_build(project='marmotta', buildtype='maven', commitlist='dev@marmotta.apache.org')
cms_staging_build(project='climate', commitlist='dev@climate.apache.org')
cms_staging_build(project='gora')
cms_staging_build(project='wink')
cms_staging_build(project='pdfbox', branch='pdfbox/cmssite')
cms_staging_build(project='steve')
cms_staging_build(project='stratos', commitlist='commits@stratos.apache.org', branch=u'stratos/site')
cms_staging_build(project='olingo', commitlist='commits@olingo.apache.org', branch=u'olingo/site')
cms_staging_build(project='metamodel', commitlist='commits@metamodel.apache.org', branch=u'metamodel/site')
cms_staging_build(project='treasurer', commitlist='treasurer@apache.org', branch=u'infrastructure/financials/src')
cms_staging_build(project='trafficserver')
cms_staging_build(project='hive', branch=u'hive/cms')
cms_staging_build(project='sentry', commitlist='commits@sentry.incubator.apache.org', branch=u'incubator/sentry/site')
cms_staging_build(project='mahout', branch=u'mahout/site/mahout_cms')
cms_staging_build(project='juddi', branch=u'juddi/cms-site')
cms_staging_build(project='thrift', branch=u'thrift/cms-site')
cms_staging_build(project='openoffice')
cms_staging_build(project='ooo-site', commitlist='commits@openoffice.apache.org', branch='openoffice/ooo-site', timeout=12000)
cms_staging_build(project='nutch', branch=u'nutch/cms_site')
cms_staging_build(project='slider', commitlist='commits@slider.incubator.apache.org', branch=u'incubator/slider/site')
cms_staging_build(project='oodt', branch=u'oodt/cms_site')
cms_staging_build(project='bookkeeper', buildtype='perl', commitlist='commits@bookkeeper.apache.org')
# cms_staging_build(project='nifi', branch=u'nifi/site')
cms_staging_build(project='tamaya', commitlist='commits@tamaya.incubator.apache.org', branch=u'incubator/tamaya/site')
cms_staging_build(project='taverna', commitlist='commits@taverna.incubator.apache.org', branch=u'incubator/taverna/site')
cms_staging_build(project='singa', commitlist='commits@singa.incubator.apache.org', buildtype='maven', branch=u'incubator/singa/site')
