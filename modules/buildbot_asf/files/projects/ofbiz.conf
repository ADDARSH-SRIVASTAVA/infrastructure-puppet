# This is the config file for the ofbiz project.

from buildbot import locks

simple_lock = locks.MasterLock("simpleLock")

# schedulers
c['schedulers'].append(AnyBranchScheduler(name="on-ofbiz-commit",
                         branches=["ofbiz/trunk"],
                         treeStableTimer=2*60,
                         builderNames=["ofbiz-trunk"]))

c['schedulers'].append(AnyBranchScheduler(name="on-ofbiz12-commit",
                         branches=["ofbiz/branches/release12.04"],
                         treeStableTimer=2*60,
                         builderNames=["ofbiz-branch12"]))

c['schedulers'].append(AnyBranchScheduler(name="on-ofbiz13-commit",
                         branches=["ofbiz/branches/release13.07"],
                         treeStableTimer=2*60,
                         builderNames=["ofbiz-branch13"]))

c['schedulers'].append(AnyBranchScheduler(name="on-ofbiz14-commit",
                         branches=["ofbiz/branches/release14.12"],
                         treeStableTimer=2*60,
                         builderNames=["ofbiz-branch14"]))



#builders
f_ofb_1 = factory.BuildFactory()
f_ofb_1.addStep(SVN(mode='full', method='clobber', repourl="https://svn.apache.org/repos/asf/ofbiz/trunk"))
# If checkout of source didn't work, then no point continuing.

f_ofb_1.addStep(Compile(command=["ant" , "load-demo"],
                    haltOnFailure=True,
))

f_ofb_1.addStep(Compile(command=["ant" , "run-tests"],
                    haltOnFailure=True,
                    locks=[simple_lock.access('exclusive')]
))

f_ofb_1.addStep(Compile(command=["ant" , "docs-all"],
                    haltOnFailure=True,
))

f_ofb_1.addStep(DirectoryUpload(slavesrc="../site/javadocs",
                            masterdest="/x1/buildmaster/master1/public_html/projects/ofbiz/site/javadocs"))

f_ofb_1.addStep(ShellCommand(
            command=['bash', '-c', 'ant -f /home/buildslave2/slave2/rat-buildfiles/ofbiz.xml -lib /home/buildslave2/'],
            description=["RAT Testing"],
            descriptionDone=["RAT Report Complete"],
	    timeout=7200,
            haltOnFailure=True,
))

# Above performs RAT tests on entire ofbiz build directories, output to txt file.
# Now we will publish that report to ci.apache.org/projects/ofbiz/rat-output.xml
# assuming that the report step itself was successful.

f_ofb_1.addStep(FileUpload(slavesrc="../rat-output.xml",
                       masterdest="/tmp/ofbiz/rat-output.xml",
               haltOnFailure=True,
))

# If we get this far, then the RAT report went fine and it was uploaded to master tmp
# dir without error. So now we can delete any previous report and move from tmp to
# published.

f_ofb_1.addStep(MasterShellCommand(command="""
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/rat-output.xml;
            cp /tmp/ofbiz/rat-output.xml /x1/buildmaster/master1/public_html/projects/ofbiz/rat-output.xml"""))

f_ofb_1.addStep(SetPropertyFromCommand(command="date +%Y-%m-%d", property="today"))

f_ofb_1.addStep(ShellCommand(
            command=["zip", "-r",
                     WithProperties("../ofbiz-trunk-%s-v%s.zip", "today", "got_revision"),
                     "."]))

f_ofb_1.addStep(FileUpload(
            slavesrc=WithProperties("../ofbiz-trunk-%s-v%s.zip", "today", "got_revision"),
            masterdest=WithProperties("/tmp/ofbiz/ofbiz-trunk-%s-v%s.zip", "today", "got_revision"),
               haltOnFailure=True,
))

# If we get this far, then the Zip went fine and it was uploaded to master tmp
# dir without error.

f_ofb_1.addStep(ShellCommand(
            command=["rm", "-f", 
                     WithProperties("../ofbiz-trunk-%s-v%s.zip", "today", "got_revision"),
                     ]))

# Below removes any other snapshots from today before inserting latest one. Leaving the last one from previous days.
# Then adds the latest snapshot
# Then remove the symlink to the older snapshot
# Then symlink -current to the latest snapshot

f_ofb_1.addStep(MasterShellCommand(command="""
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-trunk-`date +%Y-%m-%d`-*.zip;
            cp /tmp/ofbiz/ofbiz-trunk-*.zip /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/;
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-trunk-current.zip;
            ln -s /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-trunk-`date +%Y-%m-%d`-*.zip \
                  /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-trunk-current.zip"""))

# Copy HTML logs to make it available externally

f_ofb_1.addStep(DirectoryUpload(slavesrc="runtime/logs/test-results/html",
                            masterdest="/tmp/ofbiz/html",
))

f_ofb_1.addStep(MasterShellCommand(command="""
            rm -rf /x1/buildmaster/master1/public_html/projects/ofbiz/logs/trunk/html;
            cp -r /tmp/ofbiz/html /x1/buildmaster/master1/public_html/projects/ofbiz/logs/trunk""",
))

# Cleanup tmp

f_ofb_1.addStep(MasterShellCommand(command="""
            rm -rf /tmp/ofbiz""",
))

# Always run the tmp cleanup step, in case of failures part way through uploading etc..

b_ofb_1 = {'name': "ofbiz-trunk",
      'slavename': "lares_ubuntu",
      'builddir': "ofbiz-trunk",
      'factory': f_ofb_1,
      'category': "ofbiz-trunk",
      'env': {'JAVA_HOME': '/home/buildslave2/slave2/tools/java/latest1.7'}
      }

c['builders'].append(b_ofb_1)

# ofbiz-branch-12

f_ofb_4 = factory.BuildFactory()
f_ofb_4.addStep(SVN(mode='full', method='clobber', repourl="https://svn.apache.org/repos/asf/ofbiz/branches/release12.04"))
# If checkout of source didn't work, then no point continuing.

f_ofb_4.addStep(Compile(command=["ant" , "load-demo"],
                    haltOnFailure=True,
))

f_ofb_4.addStep(Compile(command=["ant" , "run-tests"],
                    haltOnFailure=True,
                    locks=[simple_lock.access('exclusive')]
))

f_ofb_4.addStep(SetPropertyFromCommand(command="date +%Y-%m-%d", property="today"))

f_ofb_4.addStep(ShellCommand(
            command=["zip", "-r",
                     WithProperties("../ofbiz-rel12.04-%s-v%s.zip", "today", "got_revision"),
                     "."]))

f_ofb_4.addStep(FileUpload(
            slavesrc=WithProperties("../ofbiz-rel12.04-%s-v%s.zip", "today", "got_revision"),
            masterdest=WithProperties("/tmp/ofbiz12/ofbiz-rel12.04-%s-v%s.zip", "today", "got_revision"),
               haltOnFailure=True,
))

# If we get this far, then the Zip went fine and it was uploaded to master tmp
# dir without error.

f_ofb_4.addStep(ShellCommand(
            command=["rm", "-f", 
                     WithProperties("../ofbiz-rel12.04-%s-v%s.zip", "today", "got_revision"),
                     ]))

# Below removes any other snapshots from today before inserting latest one. Leaving the last one from previous days.
# Then adds the latest snapshot
# Then remove the symlink to the older snapshot
# Then symlink -current to the latest snapshot

f_ofb_4.addStep(MasterShellCommand(command="""
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel12.04-`date +%Y-%m-%d`-*.zip;
            cp /tmp/ofbiz12/ofbiz-rel12.04-*.zip /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/;
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel12.04-current.zip;
            ln -s /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel12.04-`date +%Y-%m-%d`-*.zip \
                  /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel12.04-current.zip"""))

# Copy HTML logs to make it available externally

f_ofb_4.addStep(DirectoryUpload(slavesrc="runtime/logs/test-results/html",
                            masterdest="/tmp/ofbiz12/html",
))

f_ofb_4.addStep(MasterShellCommand(command="""
            rm -rf /x1/buildmaster/master1/public_html/projects/ofbiz/logs/12.04/html;
            cp -r /tmp/ofbiz12/html /x1/buildmaster/master1/public_html/projects/ofbiz/logs/12.04""",
))

# Cleanup tmp

f_ofb_4.addStep(MasterShellCommand(command="""
            rm -rf /tmp/ofbiz12""",
))

# Always run the tmp cleanup step, in case of failures part way through uploading etc..

b_ofb_4 = {'name': "ofbiz-branch12",
      'slavename': "lares_ubuntu",
      'builddir': "ofbiz-branch12",
      'factory': f_ofb_4,
      'category': "ofbiz-branch12",
      'env': {'JAVA_HOME': '/home/buildslave2/slave2/tools/java/latest1.7'}
      }

c['builders'].append(b_ofb_4)

# ofbiz-branch-13

f_ofb_2 = factory.BuildFactory()
f_ofb_2.addStep(SVN(mode='full', method='clobber', repourl="https://svn.apache.org/repos/asf/ofbiz/branches/release13.07"))
# If checkout of source didn't work, then no point continuing.

f_ofb_2.addStep(Compile(command=["ant" , "load-demo"],
                    haltOnFailure=True,
))

f_ofb_2.addStep(Compile(command=["ant" , "run-tests"],
                    haltOnFailure=True,
                    locks=[simple_lock.access('exclusive')]
))

f_ofb_2.addStep(SetPropertyFromCommand(command="date +%Y-%m-%d", property="today"))

f_ofb_2.addStep(ShellCommand(
            command=["zip", "-r",
                     WithProperties("../ofbiz-rel13.07-%s-v%s.zip", "today", "got_revision"),
                     "."]))

f_ofb_2.addStep(FileUpload(
            slavesrc=WithProperties("../ofbiz-rel13.07-%s-v%s.zip", "today", "got_revision"),
            masterdest=WithProperties("/tmp/ofbiz13/ofbiz-rel13.07-%s-v%s.zip", "today", "got_revision"),
               haltOnFailure=True,
))

# If we get this far, then the Zip went fine and it was uploaded to master tmp
# dir without error.

f_ofb_2.addStep(ShellCommand(
            command=["rm", "-f", 
                     WithProperties("../ofbiz-rel13.07-%s-v%s.zip", "today", "got_revision"),
                     ]))

# Below removes any other snapshots from today before inserting latest one. Leaving the last one from previous days.
# Then adds the latest snapshot
# Then remove the symlink to the older snapshot
# Then symlink -current to the latest snapshot

f_ofb_2.addStep(MasterShellCommand(command="""
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel13.07-`date +%Y-%m-%d`-*.zip;
            cp /tmp/ofbiz13/ofbiz-rel13.07-*.zip /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/;
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel13.07-current.zip;
            ln -s /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel13.07-`date +%Y-%m-%d`-*.zip \
                  /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel13.07-current.zip"""))

# Copy HTML logs to make it available externally

f_ofb_2.addStep(DirectoryUpload(slavesrc="runtime/logs/test-results/html",
                            masterdest="/tmp/ofbiz13/html",
))

f_ofb_2.addStep(MasterShellCommand(command="""
            rm -rf /x1/buildmaster/master1/public_html/projects/ofbiz/logs/13.07/html;
            cp -r /tmp/ofbiz13/html /x1/buildmaster/master1/public_html/projects/ofbiz/logs/13.07""",
))

# Cleanup tmp

f_ofb_2.addStep(MasterShellCommand(command="""
            rm -rf /tmp/ofbiz13""",
))

# Always run the tmp cleanup step, in case of failures part way through uploading etc..

b_ofb_2 = {'name': "ofbiz-branch13",
      'slavename': "lares_ubuntu",
      'builddir': "ofbiz-branch13",
      'factory': f_ofb_2,
      'category': "ofbiz-branch13",
      'env': {'JAVA_HOME': '/home/buildslave2/slave2/tools/java/latest1.7'}
      }

c['builders'].append(b_ofb_2)


# ofbiz-branch-14

f_ofb_14 = factory.BuildFactory()
f_ofb_14.addStep(SVN(mode='full', method='clobber', repourl="https://svn.apache.org/repos/asf/ofbiz/branches/release14.12"))
# If checkout of source didn't work, then no point continuing.

f_ofb_14.addStep(Compile(command=["ant" , "load-demo"],
                    haltOnFailure=True,
))

f_ofb_14.addStep(Compile(command=["ant" , "run-tests"],
                    haltOnFailure=True,
                    locks=[simple_lock.access('exclusive')]
))

f_ofb_14.addStep(SetPropertyFromCommand(command="date +%Y-%m-%d", property="today"))

f_ofb_14.addStep(ShellCommand(
            command=["zip", "-r",
                     WithProperties("../ofbiz-rel14.12-%s-v%s.zip", "today", "got_revision"),
                     "."]))

f_ofb_14.addStep(FileUpload(
            slavesrc=WithProperties("../ofbiz-rel14.12-%s-v%s.zip", "today", "got_revision"),
            masterdest=WithProperties("/tmp/ofbiz14/ofbiz-rel14.12-%s-v%s.zip", "today", "got_revision"),
               haltOnFailure=True,
))

# If we get this far, then the Zip went fine and it was uploaded to master tmp
# dir without error.

f_ofb_14.addStep(ShellCommand(
            command=["rm", "-f", 
                     WithProperties("../ofbiz-rel14.12-%s-v%s.zip", "today", "got_revision"),
                     ]))

# Below removes any other snapshots from today before inserting latest one. Leaving the last one from previous days.
# Then adds the latest snapshot
# Then remove the symlink to the older snapshot
# Then symlink -current to the latest snapshot

f_ofb_14.addStep(MasterShellCommand(command="""
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel14.12-`date +%Y-%m-%d`-*.zip;
            cp /tmp/ofbiz14/ofbiz-rel14.12-*.zip /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/;
            rm -f /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel14.12-current.zip;
            ln -s /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel14.12-`date +%Y-%m-%d`-*.zip \
                  /x1/buildmaster/master1/public_html/projects/ofbiz/snapshots/ofbiz-rel14.12-current.zip"""))

# Copy HTML logs to make it available externally

f_ofb_14.addStep(DirectoryUpload(slavesrc="runtime/logs/test-results/html",
                            masterdest="/tmp/ofbiz14/html",
))

f_ofb_14.addStep(MasterShellCommand(command="""
            rm -rf /x1/buildmaster/master1/public_html/projects/ofbiz/logs/14.12/html;
            cp -r /tmp/ofbiz14/html /x1/buildmaster/master1/public_html/projects/ofbiz/logs/14.12""",
))

# Cleanup tmp

f_ofb_14.addStep(MasterShellCommand(command="""
            rm -rf /tmp/ofbiz14""",
))

# Always run the tmp cleanup step, in case of failures part way through uploading etc..

b_ofb_14 = {'name': "ofbiz-branch14",
      'slavename': "lares_ubuntu",
      'builddir': "ofbiz-branch14",
      'factory': f_ofb_14,
      'category': "ofbiz-branch14",
      'env': {'JAVA_HOME': '/home/buildslave2/slave2/tools/java/latest1.7'}
      }

c['builders'].append(b_ofb_14)



################### Common part ##################


#mail status

c['status'].append(mail.MailNotifier(fromaddr="buildbot@apache.org",
                                     extraRecipients=["dev@ofbiz.apache.org"],
                                     sendToInterestedUsers=False,
                                     mode="change",
                                     categories=["ofbiz-trunk" , "ofbiz-branch12" , "ofbiz-branch13" , "ofbiz-branch14"]))

c['status'].append(words.IRC(host="irc.freenode.net", nick="ofbiz-bot",
                              allowForce=True,
                              channels=["#ofbiz"],
                  notify_events={
                'successToFailure': 1,
                'failureToSuccess': 1,
                },
                categories=["ofbiz-trunk" , "ofbiz-branch12" , "ofbiz-branch13", "ofbiz-branch14"]))

