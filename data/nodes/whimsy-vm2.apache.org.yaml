---
classes:
  - apache
  - apache::mod::authnz_ldap
  - apache::mod::headers
  - apache::mod::proxy
  - apache::mod::rewrite
  - rvm
  - vhosts_whimsy::modules
  - vhosts_whimsy::vhosts
  - whimsy_server

apache::keepalive: 'On'
apache::keepalive_timeout: '15'
apache::timeout: 600
apache::mpm_module: 'event'
apache::mod::event::listenbacklog: '511'
apache::mod::event::maxclients: '500'
apache::mod::event::maxconnectionsperchild: '200000'
apache::mod::event::maxrequestworkers: '500'
apache::mod::event::maxsparethreads: '250'
apache::mod::event::minsparethreads: '150'
apache::mod::event::serverlimit: '10'
apache::mod::event::startservers: '5'
apache::mod::event::threadlimit: '500'
apache::mod::event::threadsperchild: '50'
apache::default_vhost: false

logrotate::rule:
  apache2:
    ensure: 'present'

rvm::system_rubies:
  'ruby-2.3.0': {}

rvm::system_users:
  - vagrant

rvm::rvm_gems:
  'bundler':
     name: 'bundler'
     ruby_version: 'ruby-2.3.0'
     ensure: latest

cron:
  svnupdate:
    command: "bash -c '(for i in /srv/svn/*; do cd $i; echo; echo $i; svn cleanup; svn up; done) > /srv/whimsy/www/logs/svn-update 2>&1'"
    user: root
    minute: '*/10'

  public_committee:
    command: "(cd /srv/whimsy/www; /usr/local/bin/ruby2.3.0 roster/public_committee_info.rb public/committee-info.json > logs/public-committee-info 2>&1)"
    user: "%{apache::user}"
    minute: '*/15'

  public_icla:
    command: "(cd /srv/whimsy/www; /usr/local/bin/ruby2.3.0 roster/public_icla_info.rb public/icla-info.json > logs/public-icla-info 2>&1)"
    user: "%{apache::user}"
    minute: '*/15'

  public_member:
    command: "(cd /srv/whimsy/www; /usr/local/bin/ruby2.3.0 roster/public_member_info.rb public/member-info.json > logs/public-member-info 2>&1)"
    user: "%{apache::user}"
    minute: '*/15'

  board_minutes:
    command: "(cd /srv/whimsy/tools; /usr/bin/ruby collate_minutes.rb > ../www/logs/collate_minutes 2>&1)"
    user: "%{apache::user}"
    minute: '10'

postfix::server::inet_interfaces: 'all'
postfix::server::mailbox_command: '/usr/bin/procmail -a "$EXTENSION"'

whimsy_server::mailmap:
  secretary: "/usr/local/bin/ruby2.3.0 /srv/whimsy/www/secmail/deliver.rb"

whimsy_server::apmail_keycontent: |
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCGgAIeu+84ADF0TjKLPJaEE8747Xb+KNjh8ESujparlJcoD0EaYXZ7fF7X24Di5DzETLnv3XzLRuTUG3RzfAovrrgdIOqF23L5QMK3yNHgphNF3ri3ClwATscursH7B38QpEqTTsFGYsBwpJImKEqCkVdoLf5AVu6zhoJIsvW+mDzwvjJN/II/iFeR2/gSm73TWif0tkL7ZSspl2Dj4YNcngCL/nPmPK9tA6EJO3FcZSJzji3pfMIReBM8E0123rYF1EaNqjqF9mw3gf4jNTi9eob3l7Pchdi/onDzthpJpjw6eDcyUisYpotAO1LR0+CJpwfbxSVsjMayKUEPuop apmail@hermes.apache.org
  ssh-dss AAAAB3NzaC1kc3MAAACBAIWDVep7yb1sS56YcIlaCBU6SfvU6j2TyH41OR7QbIr12vVIkyMAOY5abrnwX9K4zupDi1cNxoG4M3XrMd/g1DW3fg9PuDEog+0WVBLauzEeRVzAf/PSfYkL0Af1+FbRlpRRjEnRwALsXKFJCbgm8PlE7FEhYhKAAeHhHnraoEcZAAAAFQCV2bd7AMVJwJHIYyFiM4mPTn8CIwAAAIA4Nf0cinMlSVpO2VUmti4zNgKO0Hk4O0XI0UWsLZQn4dqYFjhN5ceimJLDThPaL9t7Ig4g/4dKnZiU/0PZdWYGF7YUttfMoBUUbubMolhdVszysyRtaZ19vXAmgbGvi16dJSjilk7UmtPWl5Fk3o0y+y3iHAk805zCizaTOSr/mgAAAIB2bpyY3MFdNSd16GA+wojb40Y3naTsvbLVRNGM9Z4ZzxdiuKcgdLu3+g7XDvTKnIGM5IlABblsDumUrtIlBv+RxdwbbN1ey3VvW4LpVWSNEmksvlHX0+PLKNredYgqn/6V7jVdq0Z/iEK8C0Br6uSHKR5Nz1rYFtv6u0hPjBXvyg== apmail@minotaur.apache.org

vhosts_whimsy::modules::modules:
  - cgi
  - speling

vhosts_whimsy::vhosts::vhosts:
  whimsy-vm-80:
    vhost_name: '*'
    default_vhost: true
    ip: "%{::ipaddress_eth1}"
    servername: 'whimsy-test.apache.org'
    port: 80
    docroot: '/srv/whimsy/www'
    error_log_file: 'whimsy_error.log'
    access_log_file: 'whimsy_access.log'
    options:
      - '+FollowSymLinks'
      - '+MultiViews'
      - '+ExecCGI'

    passenger:
    - /classic/board/agenda
    - /racktest
    - /roster
    - /secmail
    - /test/roster

    authldap:
    - name: ASF Committers
      group: cn=committers,ou=groups,dc=apache,dc=org
      attribute: memberUid
      locations:
      - /board/subscriptions
      - /classic/roster
      - /committers
      - /test/icla
      - /test/roster

    - name: ASF Members and Incubator PMC
      group: cn=committers,ou=groups,dc=apache,dc=org
      attribute: memberUid
      locations:
      - /incubator/moderators
      - /incubator/signoff

    - name: ASF Members and Officers
      group: cn=committers,ou=groups,dc=apache,dc=org
      attribute: memberUid
      locations:
      - /board/agenda
      - /classic/board/agenda
      - /fundraising
      - /treasurer

    - name: ASF Members
      group: cn=member,ou=groups,dc=apache,dc=org
      attribute: memberUid
      locations:
      - /apmail
      - /members
      - /voter

    - name: ASF Secretarial Team
      group: cn=asf-secretary,ou=groups,ou=services,dc=apache,dc=org
      attribute: member
      locations:
      - /secretary
      - /secmail
      - /board/publish_minutes

    custom_fragment: |
      PassengerFriendlyErrorPages on
      PassengerDefaultUser %{apache::user}
      PassengerDefaultGroup %{apache::group}

      AddCharset UTF-8 .json

      <Directory /srv/whimsy/www/>
        AddHandler cgi-script .cgi
        MultiViewsMatch Any
        CheckSpelling On
      </Directory>

      <Directory /srv/whimsy/www/public/>
        Header add Access-Control-Allow-Origin "*"
        Options +Indexes
      </Directory>

      <Directory /srv/whimsy/www/logs>
        Options +Indexes
      </Directory>

      RewriteEngine on
      RewriteRule ^.*$ - [E=HTTP_AUTHORIZATION:%%{}{HTTP:Authorization}]

      RedirectMatch ^/classic/roster/committee$ https://whimsy.apache.org/classic/roster/committee/
      RedirectMatch ^/classic/roster/committer$ https://whimsy.apache.org/classic/roster/committer/

      RedirectMatch ^/officers/mlreq(/.*)?$ https://infra.apache.org/officers/mlreq$1

      RedirectMatch ^/officers/public_names https://whimsy.apache.org/secretary/public-names

      <Location /board/agenda/>
        # see /srv/puma/README
        ProxyPass http://localhost:7001/
        RequestHeader set X-WUNDERBAR-BASE /board/agenda/
        SetEnv HTTPS on
      </Location>
