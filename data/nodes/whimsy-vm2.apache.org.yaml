---
classes:
  - apache
  - apache::mod::authnz_ldap
  - apache::mod::headers
  - apache::mod::proxy
  - apache::mod::rewrite
  - rvm
  - vhosts_whimsy::modules
  - vhosts_whimsy::vhosts
  - whimsy_server

apache::keepalive: 'On'
apache::keepalive_timeout: '15'
apache::timeout: 600
apache::mpm_module: 'event'
apache::mod::event::listenbacklog: '511'
apache::mod::event::maxclients: '500'
apache::mod::event::maxconnectionsperchild: '200000'
apache::mod::event::maxrequestworkers: '500'
apache::mod::event::maxsparethreads: '250'
apache::mod::event::minsparethreads: '150'
apache::mod::event::serverlimit: '10'
apache::mod::event::startservers: '5'
apache::mod::event::threadlimit: '500'
apache::mod::event::threadsperchild: '50'
apache::default_vhost: false

logrotate::rule:
  apache2:
    ensure: 'present'

rvm::system_rubies:
  'ruby-2.3.0': {}

rvm::system_users:
  - vagrant

rvm::rvm_gems:
  'bundler':
     name: 'bundler'
     ruby_version: 'ruby-2.3.0'
     ensure: latest

whimsy_server::crontab_entries:
  svnupdate:
    command: "bash -c 'for i in /srv/svn/*; do (cd $i; svn cleanup; svn up)>/dev/null; done"
    user: root
    minute: '*/10'

whimsy_server::apmail_keycontent: |
  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCGgAIeu+84ADF0TjKLPJaEE8747Xb+KNjh8ESujparlJcoD0EaYXZ7fF7X24Di5DzETLnv3XzLRuTUG3RzfAovrrgdIOqF23L5QMK3yNHgphNF3ri3ClwATscursH7B38QpEqTTsFGYsBwpJImKEqCkVdoLf5AVu6zhoJIsvW+mDzwvjJN/II/iFeR2/gSm73TWif0tkL7ZSspl2Dj4YNcngCL/nPmPK9tA6EJO3FcZSJzji3pfMIReBM8E0123rYF1EaNqjqF9mw3gf4jNTi9eob3l7Pchdi/onDzthpJpjw6eDcyUisYpotAO1LR0+CJpwfbxSVsjMayKUEPuop apmail@hermes.apache.org

vhosts_whimsy::modules::modules:
  - cgi
  - speling

vhosts_whimsy::vhosts::vhosts:
  whimsy-vm-80:
    vhost_name: '*'
    default_vhost: true
    ip: "%{::ipaddress_eth1}"
    servername: 'whimsy-test.apache.org'
    port: 80
    docroot: '/srv/whimsy/www'
    error_log_file: 'whimsy_error.log'
    access_log_file: 'whimsy_access.log'

    passenger:
    - /classic/board/agenda
    - /racktest
    - /roster
    - /secmail
    - /test/roster

    authldap:
    - name: ASF Committers
      group: cn=committers,ou=groups,dc=apache,dc=org
      attribute: memberUid
      locations:
      - /board/subscriptions
      - /classic/roster
      - /committers
      - /test/icla
      - /test/roster

    - name: ASF Members and Incubator PMC
      group: cn=committers,ou=groups,dc=apache,dc=org
      attribute: memberUid
      locations:
      - /incubator/moderators
      - /incubator/signoff

    - name: ASF Members and Officers
      group: cn=committers,ou=groups,dc=apache,dc=org
      attribute: memberUid
      locations:
      - /board/agenda
      - /classic/board/agenda
      - /fundraising
      - /treasurer

    - name: ASF Members
      group: cn=member,ou=groups,dc=apache,dc=org
      attribute: memberUid
      locations:
      - /apmail
      - /members
      - /voter

    - name: ASF Secretarial Team
      group: cn=asf-secretary,ou=groups,ou=services,dc=apache,dc=org
      attribute: member
      locations:
      - /secretary
      - /secmail
      - /board/publish_minutes

    custom_fragment: |
      AddCharset UTF-8 .json

      <Directory />
        Options +FollowSymLinks
        AllowOverride None
      </Directory>

      <Directory /srv/whimsy/www/>
        Options +FollowSymLinks +MultiViews +ExecCGI
        AddHandler cgi-script .cgi
        MultiViewsMatch Any
        AllowOverride None
        CheckSpelling On
      </Directory>

      <Directory /srv/whimsy/www/public/>
        Header add Access-Control-Allow-Origin "*"
        Options +Indexes
      </Directory>

      RewriteEngine on
      RewriteRule ^.*$ - [E=HTTP_AUTHORIZATION:%%{}{HTTP:Authorization}]

      RedirectMatch ^/classic/roster/committee$ https://whimsy.apache.org/classic/roster/committee/
      RedirectMatch ^/classic/roster/committer$ https://whimsy.apache.org/classic/roster/committer/

      RedirectMatch ^/officers/mlreq(/.*)?$ https://infra.apache.org/officers/mlreq$1

      RedirectMatch ^/officers/public_names https://whimsy.apache.org/secretary/public-names

      <Location /board/agenda/>
        # see /srv/puma/README
        ProxyPass http://localhost:7001/
        RequestHeader set X-WUNDERBAR-BASE /board/agenda/
        SetEnv HTTPS on
      </Location>

      <Directory /srv/whimsy/www/logs>
        Options +Indexes
      </Directory>
