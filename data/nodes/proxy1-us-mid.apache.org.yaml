---
classes:
  - apache
  - apache::mod::headers
  - apache::mod::proxy
  - apache::mod::proxy_http
  - apache::mod::rewrite
  - vhosts_asf::modules
  - vhosts_asf::vhosts

apache::default_vhost: false

vhosts_asf::modules::modules:
  remoteip:
    name: 'remoteip'

vhosts_asf::vhosts::vhosts:
  proxy:
    vhost_name: '*'
    port: 80
    servername: 'bztest.apache.org'
    docroot: '/var/www/issues-data'
    access_log_format: '%a %l %u %t \"%r\" %>s %O \"%%{}{Referer}i\" \"%%{}{User-Agent}i\"'
    access_log_env_var: 'combined_forwarded'
    setenv: 'combined_forwarded'
    access_log_file: 'weblog.log'
    error_log_file:  'errorlog.log'
    ensure: 'present'
    custom_fragment: |
      RemoteIPHeader X-Forwarded-For

      ProxyPreserveHost on

      # Need to use mod_rewrite fir Jira redirects and for when doing maintenance
      RewriteEngine on

      # Main Bugzilla instance on eir.zones
      ProxyPass /bugzilla                 http://192.168.3.4:80/bugzilla                 retry=0 timeout=60
      ProxyPass /bugzilla/sanitycheck.cgi http://192.168.3.4:80/bugzilla/sanitycheck.cgi retry=0 timeout=300
      SetEnvIf Request_URI "^/bugzilla" asf_proxy=eir.mainbz
      # To enable system maintenance, comment out the two lines above and uncomment the five lines below
      # Note: Modify the hardcoded IP as necessary to allow you to access Jira during maintenance
      # RewriteCond %%{}{REQUEST_URI} !/bugzilla/maintenance.html
      # RewriteCond %%{}{REMOTE_ADDR} !2\.24\.211\.105
      # RewriteRule ^/bugzilla/(.*) /bugzilla/maintenance.html
      # RewriteCond %%{}{REMOTE_ADDR} 2\.24\.211\.105
      # RewriteRule ^/bugzilla/(.*) http://192.168.3.4:80/bugzilla/$1 [P]
      <Location /bugzilla>
        Header edit Set-Cookie (^.*$) "$1; Secure"
      </Location>
