---
classes:
  - apache
  - apache::mod::dav_svn
  - apache::mod::rewrite
  - apache::mod::ssl
  - apache_modules
  - apache_modules::mod_svn_check_path
  - collectd
  - collectd::plugin::cpu
  - collectd::plugin::load
  - collectd::plugin::memory
  - collectd::plugin::interface
  - collectd::plugin::write_http
  - puppet_asf
  - ssl::name::wildcard_apache_org
  - subversion_server
  - tlp_vhosts::vhosts_asf
  - zfs_on_ubuntu
  
apache::keepalive:          'On'
apache::keepalive_timeout:  '30'
apache::default_vhost:      true
apache::docroot:            '/x1/www/htdocs'

apache::mod::event::listenbacklog: '511'
apache::mod::event::maxclients: '250'
apache::mod::event::maxconnectionsperchild: '200000'
apache::mod::event::maxrequestworkers: '500'
apache::mod::event::maxsparethreads: '150'
apache::mod::event::minsparethreads: '150'
apache::mod::event::serverlimit: '10'
apache::mod::event::startservers: '5'
apache::mod::event::threadlimit: '250'
apache::mod::event::threadsperchild: '50'

apache::mpm_module:         'event'
apache::serveradmin:        'infrastructure@apache.org'

apache_modules::dev_package:
  - apache2-dev

asf-fail2ban::jails::jails:
  httpd-svn:
    filter: asf-httpd
    action: 
      - asf-ban-httpd
      - asf-sendmail[name="HTTPD (Authentication)", hostname="hades", dest=root@apache.org, sender=fail2ban@apache.org, logpath="/var/log/vc/error_log"]
    logpath: /var/log/vc/error_log
    findtime: 1800
    maxretry: 100
  
collectd::purge:  true
collectd::recurse: true
collectd::purge_config: true

collectd::plugin::interface::interfaces: 
  - lo
collectd::plugin::interface::ignoreselected: true

tlp_vhosts::vhosts_asf::vhosts:
    svn:
      vhost_name: 'svn.apache.org'
      port: 80
      docroot: '/x1/svn'
      servername: 'svn.apache.org'
      serveraliases:
        - svn-master.apache.org
        - svn.*.apache.org
        - hades.apache.org
        - hades.*.apache.org
      rewrites:
        -
          rewrite_cond:
            - '%%{}{IS_SUBREQ} =false' # %%{}{VAR} is a nasty hack for %{} escaping
            - '%%{}{REQUEST_METHOD} =GET [OR]'
            - '%%{}{REQUEST_METHOD} =HEAD'
            - '%%{}{REQUEST_URI} /repos/asf/incubator/(.+)'
            - '/repos/asf/%1?ckpath -U'
          rewrite_rule:
            - '.* /repos/asf/%1 [L,R=301]'
        -
          rewrite_cond:
            - '%%{}{IS_SUBREQ} =false'
            - '%%{}{REQUEST_METHOD} =PROPFIND'
            - '%%{}{REQUEST_URI} /repos/asf/!svn/(?:bc|rvr)/(\d+)/incubator/(.+)'
            - '/repos/asf/%2?ckpath -U'
          rewrite_rule:
            - '.* /repos/asf/%2 [L,R=301]'
        -
          rewrite_cond:
            - '%%{}{IS_SUBREQ} =false'
            - '%%{}{REQUEST_METHOD} =REPORT'
            - '%%{}{REQUEST_URI} /repos/asf/!svn/(vcc/default|me)'
            - '/repos/asf?ckpath=/repos/asf/incubator -U'
          rewrite_rule:
            - '.* %%{}{PATH_INFO} [L,R=301]'
      custom_fragment: |
        <Location /repos/asf>'
          DAV svn
          SVNPath /x1/svn/asf
          SVNCheckPathPrefix  /repos/asf

          SetOutputFilter DEFLATE
          AuthzSVNAccessFile /x1/svn/asf-authorization
            
          LimitRequestBody 100000000

          <LimitExcept GET POST OPTIONS PROPFIND REPORT>
            Order allow,deny
            Deny from all
          </LimitExcept>
        </Location>


